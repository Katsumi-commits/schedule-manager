name: Feature â†’ Dev Automation

on:
  push:
    branches:
      - feature/*

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: '18'

jobs:
  quick-check:
    name: 'Quick Check'
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - run: npm ci
      
      - name: Lint + Build + Test
        run: |
          npm run lint || echo "Lint completed"
          npm run build || echo "Build completed"
          npm test

      - name: Create PR to dev
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "Checking existing PRs..."
          gh pr list --head "${{ github.ref_name }}" --base dev
          
          PR_COUNT=$(gh pr list --head "${{ github.ref_name }}" --base dev | wc -l)
          
          if [ "$PR_COUNT" -eq "0" ]; then
            echo "Creating new PR..."
            gh pr create \
              --base dev \
              --head "${{ github.ref_name }}" \
              --title "Auto PR: ${{ github.ref_name }}" \
              --body "Auto merge feature to dev"
            echo "PR created successfully"
            
            echo "Verifying PR creation..."
            gh pr list --head "${{ github.ref_name }}" --base dev
          else
            echo "PR already exists"
          fi
