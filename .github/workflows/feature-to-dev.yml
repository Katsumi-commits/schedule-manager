name: Feature â†’ Dev Automation

on:
  push:
    branches:
      - feature/*

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: '18'

jobs:
  quick-check:
    name: 'Quick Check'
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - run: npm ci
      
      - name: Lint + Build + Test
        run: |
          npm run lint || echo "Lint completed"
          npm run build || echo "Build completed"
          npm test

      - name: Create PR to dev
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "Fetching remote branches..."
          git fetch origin dev
          
          echo "Checking for changes between branches..."
          CHANGES=$(git diff --name-only origin/dev || echo "changes-detected")
          
          if [ -z "$CHANGES" ]; then
            echo "No changes detected between dev and ${{ github.ref_name }}"
            echo "Skipping PR creation"
            exit 0
          fi
          
          echo "Changes detected: $CHANGES"
          
          EXISTING_PR=$(gh pr list --head ${{ github.ref_name }} --base dev --json number --jq '.[0].number')
          
          if [ "$EXISTING_PR" = "null" ] || [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --title "Auto PR: ${{ github.ref_name }}" \
              --body "Auto-generated Pull Request from ${{ github.ref_name }}" \
              --base dev \
              --head ${{ github.ref_name }}
            echo "PR created successfully"
          else
            echo "PR already exists: #$EXISTING_PR"
          fi
